<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>test</title>
    <style>
      body {
        width: 100vw;
        padding: 0;
        margin: 0;
        background-color: #f4f4f4;
      }
      main {
        width: calc(100vw - 400px);
        padding-left: 200px;
        padding-right: 200px;
      }
      #vacancies-container {
        display: flex;
        flex-direction: column;
        margin-top: 20px;
        margin-bottom: 20px;
        gap: 16px;
        min-height: 100vh;
      }
      .vacancy {
        padding: 20px 30px;
        background-color: white;
        border: solid #e7e9ed 3px;
        border-radius: 10px;
      }
      .company {
        display: flex;
        column-gap: 8px;
        align-items: center;
      }
      .tags {
        display: flex;
        gap: 4px;
      }
      .tag {
        padding: 4px 8px;
        background-color: #e7e9ed;
        border-radius: 8px;
      }
      .company-reviews {
        margin-left: 20px;
      }
      .paginator {
        display: grid;
        grid-template-columns: 66px 1fr 66px;
        column-gap: 10px;
        width: 100%;
      }
      .page-buttons {
        display: flex;
        flex-direction: row;
        gap: 10px;
      }
      .page-numbers {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 6px;
        overflow: hidden;
        justify-content: center;
      }
      .page-button {
        width: 30px;
        height: 30px;
        background-color: #1b57b2;
        color: white;
        border: none;
        border-radius: 9px;
        flex-shrink: 0;
      }
      .active {
        background-color: #4d89e4;
      }
      @media (max-width: 1024px) {
        main {
          padding-left: 20px;
          padding-right: 20px;
          width: calc(100vw - 40px);
        }
      }
    </style>
  </head>
  <body>
    <header></header>
    <main>
      <div id="filters-container"></div>
      <h1>Вакансии по Ростовской области</h1>
      <div class="paginator">
        <div class="page-buttons">
          <button class="page-button"><<</button>
          <button onclick="setPrevPage()" class="page-button"><</button>
        </div>
        <div class="page-numbers"></div>
        <div class="page-buttons">
          <button onclick="setNextPage()" class="page-button">></button>
          <button class="page-button">>></button>
        </div>
      </div>
      <div id="vacancies-container"></div>
      <div class="paginator">
        <div class="page-buttons">
          <button class="page-button"><<</button>
          <button class="page-button"><</button>
        </div>
        <div class="page-numbers"></div>
        <div class="page-buttons">
          <button class="page-button">></button>
          <button class="page-button">>></button>
        </div>
      </div>
    </main>
  </body>
  <script>
    //--------state--------

    state = {
      vacancies: {
        isError: false,
        isLoading: false,
        items: [],
        fetchquery: {
          page: 0,
        },
      },
    };

    //---------------------

    //------------------------------------------api--------------------------------------

    const fetchVacancies = async () => {
      let interval
      try {
        state.vacancies.isLoading = true;
        state.vacancies.isError = false;
        query = state.vacancies.fetchquery;
        interval = setInterval(() => {
          renderVacancies()
        }, 200);
        const res = await fetch(
          `https://api.hh.ru/vacancies?page=${query.page}&per_page=10&area=1530`
        );
        if (!res.ok) {
          state.vacancies.isError = true;
          clearInterval(interval)
        } else {
          const body = await res.json();
          if (body.items) {
            state.vacancies.items = body.items;
          }
        }
      } catch (e) {
        state.vacancies.isError = true;
        console.log(e);
        clearInterval(interval)
      } finally {
        state.vacancies.isLoading = false;
        clearInterval(interval)
        renderVacancies()
      }
    };

    //-----------------------------------------------------------------------------------

    // -----------------vacancy building-------------------------

    const onVacancyClick = (url) => {
      //open hh.ru on new page
      console.log("it works");
      newWindow = window.open(url);
      if (!newWindow.closed && newWindow) newWindow.focus();
    };

    const parseTags = (item, vacancyTags) => {
      let tags_arr = [];
      if (item.experience) {
        tags_arr.push(item.experience.name);
      }
      if (
        Object.values(item.work_format).find((format) => format.id === "REMOTE")
      ) {
        tags_arr.push("Можно удалённо");
      }
      if (item.working_hours.length > 0) {
        if (item.working_hours[0].name !== "Другое") {
          tags_arr.push(item.working_hours[0].name);
        }
      }
      if (item.work_schedule_by_days.length > 0) {
        if (item.work_schedule_by_days[0].name !== "Другое") {
          tags_arr.push(item.work_schedule_by_days[0].name);
        }
      }
      tags_arr.forEach((tagText) => {
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.innerText = tagText;
        vacancyTags.appendChild(tag);
      });
    };

    const attachVacancyName = (name, vacancy) => {
      const vacancyName = document.createElement("h2");
      vacancyName.className = "name";
      vacancyName.textContent = name;
      vacancy.appendChild(vacancyName);
    };

    const attachVacancySalary = (salary_range, vacancy) => {
      if (salary_range) {
        const vacancySalary = document.createElement("p");
        vacancySalary.className = "salary";
        let innerText = "";
        if (salary_range.from) {
          innerText += `от ${salary_range.from} `;
        }
        if (salary_range.to) {
          innerText += ` до ${salary_range.to} `;
        }
        innerText += " " + salary_range.mode.name.toLowerCase();
        vacancySalary.innerText = innerText;
        vacancy.appendChild(vacancySalary);
      }
    };

    const attachVacancyTags = (item, vacancy) => {
      const vacancyTags = document.createElement("div");
      vacancyTags.className = "tags";
      parseTags(item, vacancyTags);
      vacancy.appendChild(vacancyTags);
    };

    const attachVacancyCompany = (employer, vacancy) => {
      const wrapper = document.createElement("div");
      wrapper.className = "company";
      const name = document.createElement("h3");
      name.className = "company-name";
      name.innerText = employer.name;
      wrapper.appendChild(name);
      if (employer.employer_rating) {
        const rating = document.createElement("p");
        rating.className = "company-rating";
        rating.innerText = employer.employer_rating.total_rating + "/5";
        const reviews = document.createElement("p");
        reviews.className = "company-reviews";
        reviews.innerText = employer.employer_rating.reviews_count + " отзывов";
        wrapper.appendChild(rating);
        wrapper.appendChild(reviews);
      }
      vacancy.appendChild(wrapper);
    };

    const attachVacancyArea = (area, vacancy) => {
      const vacancyArea = document.createElement("p");
      vacancyArea.className = "area";
      vacancyArea.innerText = area.name;
      vacancy.appendChild(vacancyArea);
    };

    const buildVacancy = (vacancy) => {
      const vacancyComponent = document.createElement("div");
      vacancyComponent.className = "vacancy";
      vacancyComponent.addEventListener("click", () =>
        onVacancyClick(vacancy.alternate_url)
      );
      attachVacancyName(vacancy.name, vacancyComponent);
      attachVacancySalary(vacancy.salary_range, vacancyComponent);
      attachVacancyTags(vacancy, vacancyComponent);
      attachVacancyCompany(vacancy.employer, vacancyComponent);
      attachVacancyArea(vacancy.area, vacancyComponent);
      return vacancyComponent;
    };

    //-----------------------------------------------------------

    //------------------pagination logic------------------------

    const getPageArr = () => {
      const currentPage = state.vacancies.fetchquery.page;
      const container = document.getElementsByClassName("page-numbers").item(0);
      const width = container.clientWidth;
      const pageAmount = ~~((width + 6) / 36);
      let pageArr = [];
      if (currentPage < 4) {
        for (let i = 0; i < pageAmount; i++) {
          pageArr.push(i + 1);
        }
      } else {
        for (let i = 0; i < pageAmount; i++) {
          pageArr.push(i + currentPage - 2);
        }
      }
      return pageArr;
    };

    const setPage = (page) => {
      state.vacancies.fetchquery.page = page;
      fetchVacancies();
      renderPaginator();
    };

    const setNextPage = () => {
      setPage(state.vacancies.fetchquery.page + 1);
    };
    const setPrevPage = () => {
      if (state.vacancies.fetchquery.page > 0) {
        setPage(state.vacancies.fetchquery.page - 1);
      }
    };

    const pageButtonBuilder = (page) => {
      const pageComponent = document.createElement("button");
      pageComponent.className = `${
        state.vacancies.fetchquery.page == page - 1
          ? "page-button active"
          : "page-button"
      }`;
      pageComponent.innerText = page;
      pageComponent.addEventListener("click", () => setPage(page - 1));
      return pageComponent;
    };

    //----------------------------------------------------------

    //-------------------page changers---------------------

    const renderVacancies = () => {
      const container = document.getElementById("vacancies-container");
      container.innerHTML = "";
      if (state.vacancies.isError) {
        container.innerText = "something went wrong";
      } else if (state.vacancies.isLoading) {
        container.innerText = "Loading...";
      } else {
        vacancies = state.vacancies.items;
        vacancies.forEach((vacancy) => {
          const vacancyComponent = buildVacancy(vacancy);
          container.appendChild(vacancyComponent);
        });
      }
    };

    const renderPaginator = () => {
      const paginators = document.querySelectorAll(".page-numbers");
      paginators.forEach((item) => (item.innerHTML = ""));
      const pageArr = getPageArr();
      paginators.forEach((item) => {
        pageArr.forEach((page) => {
          const pageComponent = pageButtonBuilder(page);
          item.appendChild(pageComponent);
        });
      });
    };

    window.onresize = renderPaginator;

    //-------------------------------------------------------

    //---------initialization-----------

    const init = () => {
      fetchVacancies();
      renderPaginator();
    };

    window.onload = init;

    //----------------------------------
  </script>
</html>
